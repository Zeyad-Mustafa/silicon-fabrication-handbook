import React, { useEffect, useRef, useState } from 'react';
import { Camera, RotateCcw, Maximize2, ZoomIn, ZoomOut, Grid3x3, Box, Eye, EyeOff } from 'lucide-react';
import * as THREE from 'three';

const MembraneSensorViewer = () => {
  const containerRef = useRef(null);
  const sceneRef = useRef(null);
  const rendererRef = useRef(null);
  const cameraRef = useRef(null);
  const meshRef = useRef(null);
  const controlsRef = useRef(null);
  const frameRef = useRef(null);
  
  const [isRotating, setIsRotating] = useState(true);
  const [wireframe, setWireframe] = useState(false);
  const [showEdges, setShowEdges] = useState(true);
  const [explodedView, setExplodedView] = useState(false);
  const [viewMode, setViewMode] = useState('solid');
  const [showGrid, setShowGrid] = useState(true);
  const [isClient, setIsClient] = useState(false);
  const [zoomLevel, setZoomLevel] = useState(150);

  // Initialize client-side flag
  useEffect(() => {
    setIsClient(true);
  }, []);

  // Initialize 3D scene
  useEffect(() => {
    if (!isClient || !containerRef.current) return;

    // Create scene
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a0a0a);
    sceneRef.current = scene;

    // Create camera
    const camera = new THREE.PerspectiveCamera(
      50,
      containerRef.current.clientWidth / containerRef.current.clientHeight,
      0.1,
      1000
    );
    camera.position.set(150, 120, 150);
    camera.lookAt(50, 50, 4);
    cameraRef.current = camera;

    // Create renderer
    const renderer = new THREE.WebGLRenderer({ 
      antialias: true, 
      alpha: true,
      powerPreference: "high-performance"
    });
    renderer.setSize(containerRef.current.clientWidth, containerRef.current.clientHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    containerRef.current.appendChild(renderer.domElement);
    rendererRef.current = renderer;

    // Enhanced lighting setup
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
    scene.add(ambientLight);

    const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
    mainLight.position.set(100, 150, 100);
    mainLight.castShadow = true;
    mainLight.shadow.mapSize.width = 2048;
    mainLight.shadow.mapSize.height = 2048;
    scene.add(mainLight);

    const fillLight = new THREE.DirectionalLight(0x4a9eff, 0.3);
    fillLight.position.set(-100, 50, -100);
    scene.add(fillLight);

    const backLight = new THREE.DirectionalLight(0xff6b9d, 0.2);
    backLight.position.set(0, -50, -100);
    scene.add(backLight);

    // Parse STL data
    const stlData = `solid MembraneSensor
  facet normal 0 0 -1
    outer loop
      vertex 0 0 0
      vertex 100 0 0
      vertex 100 100 0
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 0 0 0
      vertex 100 100 0
      vertex 0 100 0
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 0 0 5
      vertex 100 100 5
      vertex 100 0 5
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 0 0 5
      vertex 0 100 5
      vertex 100 100 5
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 0 0 0
      vertex 100 0 0
      vertex 100 0 5
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 0 0 0
      vertex 100 0 5
      vertex 0 0 5
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 0 100 0
      vertex 100 100 5
      vertex 100 100 0
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 0 100 0
      vertex 0 100 5
      vertex 100 100 5
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 0 0 0
      vertex 0 100 0
      vertex 0 100 5
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 0 0 0
      vertex 0 100 5
      vertex 0 0 5
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 100 0 0
      vertex 100 100 5
      vertex 100 100 0
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 100 0 0
      vertex 100 0 5
      vertex 100 100 5
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 10 10 5
      vertex 90 10 5
      vertex 90 90 5
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 10 10 5
      vertex 90 90 5
      vertex 10 90 5
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 10 10 5.5
      vertex 90 90 5.5
      vertex 90 10 5.5
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 10 10 5.5
      vertex 10 90 5.5
      vertex 90 90 5.5
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 10 10 5
      vertex 90 10 5
      vertex 90 10 5.5
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 10 10 5
      vertex 90 10 5.5
      vertex 10 10 5.5
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 10 90 5
      vertex 90 90 5.5
      vertex 90 90 5
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 10 90 5
      vertex 10 90 5.5
      vertex 90 90 5.5
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 10 10 5
      vertex 10 90 5
      vertex 10 90 5.5
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 10 10 5
      vertex 10 90 5.5
      vertex 10 10 5.5
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 90 10 5
      vertex 90 90 5.5
      vertex 90 90 5
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 90 10 5
      vertex 90 10 5.5
      vertex 90 90 5.5
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 35 35 5.5
      vertex 65 35 5.5
      vertex 65 65 5.5
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 35 35 5.5
      vertex 65 65 5.5
      vertex 35 65 5.5
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 35 35 6
      vertex 65 65 6
      vertex 65 35 6
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 35 35 6
      vertex 35 65 6
      vertex 65 65 6
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 35 35 5.5
      vertex 65 35 5.5
      vertex 65 35 6
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 35 35 5.5
      vertex 65 35 6
      vertex 35 35 6
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 35 65 5.5
      vertex 65 65 6
      vertex 65 65 5.5
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 35 65 5.5
      vertex 35 65 6
      vertex 65 65 6
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 35 35 5.5
      vertex 35 65 5.5
      vertex 35 65 6
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 35 35 5.5
      vertex 35 65 6
      vertex 35 35 6
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 65 35 5.5
      vertex 65 65 6
      vertex 65 65 5.5
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 65 35 5.5
      vertex 65 35 6
      vertex 65 65 6
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 5 45 0
      vertex 10 45 0
      vertex 10 55 0
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 5 45 0
      vertex 10 55 0
      vertex 5 55 0
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 5 45 5
      vertex 10 55 5
      vertex 10 45 5
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 5 45 5
      vertex 5 55 5
      vertex 10 55 5
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 5 45 0
      vertex 10 45 0
      vertex 10 45 5
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 5 45 0
      vertex 10 45 5
      vertex 5 45 5
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 5 55 0
      vertex 10 55 5
      vertex 10 55 0
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 5 55 0
      vertex 5 55 5
      vertex 10 55 5
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 5 45 0
      vertex 5 55 0
      vertex 5 55 5
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 5 45 0
      vertex 5 55 5
      vertex 5 45 5
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 10 45 0
      vertex 10 55 5
      vertex 10 55 0
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 10 45 0
      vertex 10 45 5
      vertex 10 55 5
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 90 45 0
      vertex 95 45 0
      vertex 95 55 0
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 90 45 0
      vertex 95 55 0
      vertex 90 55 0
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 90 45 5
      vertex 95 55 5
      vertex 95 45 5
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 90 45 5
      vertex 90 55 5
      vertex 95 55 5
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 90 45 0
      vertex 95 45 0
      vertex 95 45 5
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 90 45 0
      vertex 95 45 5
      vertex 90 45 5
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 90 55 0
      vertex 95 55 5
      vertex 95 55 0
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 90 55 0
      vertex 90 55 5
      vertex 95 55 5
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 90 45 0
      vertex 90 55 0
      vertex 90 55 5
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 90 45 0
      vertex 90 55 5
      vertex 90 45 5
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 95 45 0
      vertex 95 55 5
      vertex 95 55 0
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 95 45 0
      vertex 95 45 5
      vertex 95 55 5
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 45 5 0
      vertex 55 5 0
      vertex 55 10 0
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 45 5 0
      vertex 55 10 0
      vertex 45 10 0
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 45 5 5
      vertex 55 10 5
      vertex 55 5 5
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 45 5 5
      vertex 45 10 5
      vertex 55 10 5
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 45 5 0
      vertex 55 5 0
      vertex 55 5 5
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 45 5 0
      vertex 55 5 5
      vertex 45 5 5
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 45 10 0
      vertex 55 10 5
      vertex 55 10 0
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 45 10 0
      vertex 45 10 5
      vertex 55 10 5
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 45 5 0
      vertex 45 10 0
      vertex 45 10 5
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 45 5 0
      vertex 45 10 5
      vertex 45 5 5
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 55 5 0
      vertex 55 10 5
      vertex 55 10 0
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 55 5 0
      vertex 55 5 5
      vertex 55 10 5
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 45 90 0
      vertex 55 90 0
      vertex 55 95 0
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 45 90 0
      vertex 55 95 0
      vertex 45 95 0
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 45 90 5
      vertex 55 95 5
      vertex 55 90 5
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 45 90 5
      vertex 45 95 5
      vertex 55 95 5
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 45 90 0
      vertex 55 90 0
      vertex 55 90 5
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 45 90 0
      vertex 55 90 5
      vertex 45 90 5
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 45 95 0
      vertex 55 95 5
      vertex 55 95 0
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 45 95 0
      vertex 45 95 5
      vertex 55 95 5
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 45 90 0
      vertex 45 95 0
      vertex 45 95 5
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 45 90 0
      vertex 45 95 5
      vertex 45 90 5
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 55 90 0
      vertex 55 95 5
      vertex 55 95 0
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 55 90 0
      vertex 55 90 5
      vertex 55 95 5
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 42 42 6
      vertex 58 42 6
      vertex 58 58 6
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 42 42 6
      vertex 58 58 6
      vertex 42 58 6
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 42 42 8
      vertex 58 58 8
      vertex 58 42 8
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 42 42 8
      vertex 42 58 8
      vertex 58 58 8
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 42 42 6
      vertex 58 42 6
      vertex 58 42 8
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 42 42 6
      vertex 58 42 8
      vertex 42 42 8
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 42 58 6
      vertex 58 58 8
      vertex 58 58 6
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 42 58 6
      vertex 42 58 8
      vertex 58 58 8
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 42 42 6
      vertex 42 58 6
      vertex 42 58 8
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 42 42 6
      vertex 42 58 8
      vertex 42 42 8
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 58 42 6
      vertex 58 58 8
      vertex 58 58 6
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 58 42 6
      vertex 58 42 8
      vertex 58 58 8
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 46 46 8
      vertex 54 46 8
      vertex 54 54 8
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 46 46 8
      vertex 54 54 8
      vertex 46 54 8
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 46 46 9
      vertex 54 54 9
      vertex 54 46 9
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 46 46 9
      vertex 46 54 9
      vertex 54 54 9
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 46 46 8
      vertex 54 46 8
      vertex 54 46 9
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 46 46 8
      vertex 54 46 9
      vertex 46 46 9
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 46 54 8
      vertex 54 54 9
      vertex 54 54 8
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 46 54 8
      vertex 46 54 9
      vertex 54 54 9
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 46 46 8
      vertex 46 54 8
      vertex 46 54 9
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 46 46 8
      vertex 46 54 9
      vertex 46 46 9
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 54 46 8
      vertex 54 54 9
      vertex 54 54 8
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 54 46 8
      vertex 54 46 9
      vertex 54 54 9
    endloop
  endfacet
endsolid MembraneSensor`;

    // Parse STL geometry
    const geometry = new THREE.BufferGeometry();
    const vertices = [];
    const normals = [];

    const lines = stlData.split('\n');
    let currentNormal = null;
    let currentVertices = [];

    for (let line of lines) {
      line = line.trim();
      if (line.startsWith('facet normal')) {
        const parts = line.split(/\s+/);
        currentNormal = [parseFloat(parts[2]), parseFloat(parts[3]), parseFloat(parts[4])];
      } else if (line.startsWith('vertex')) {
        const parts = line.split(/\s+/);
        currentVertices.push(parseFloat(parts[1]), parseFloat(parts[2]), parseFloat(parts[3]));
      } else if (line.startsWith('endfacet')) {
        for (let i = 0; i < currentVertices.length; i += 3) {
          vertices.push(currentVertices[i], currentVertices[i + 1], currentVertices[i + 2]);
          normals.push(currentNormal[0], currentNormal[1], currentNormal[2]);
        }
        currentVertices = [];
      }
    }

    geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
    geometry.setAttribute('normal', new THREE.Float32BufferAttribute(normals, 3));
    geometry.computeBoundingSphere();

    // Create main mesh group
    const group = new THREE.Group();
    
    const material = new THREE.MeshPhysicalMaterial({
      color: 0x3b82f6,
      metalness: 0.3,
      roughness: 0.4,
      clearcoat: 0.8,
      clearcoatRoughness: 0.2,
      side: THREE.DoubleSide,
      transparent: true,
      opacity: 0.95
    });

    const mesh = new THREE.Mesh(geometry, material);
    mesh.castShadow = true;
    mesh.receiveShadow = true;
    group.add(mesh);

    // Add edge lines
    const edges = new THREE.EdgesGeometry(geometry);
    const edgeMaterial = new THREE.LineBasicMaterial({ 
      color: 0x00ffff,
      transparent: true,
      opacity: 0.4,
      linewidth: 1
    });
    const edgeLines = new THREE.LineSegments(edges, edgeMaterial);
    edgeLines.visible = showEdges;
    group.add(edgeLines);

    // Center the model
    const box = new THREE.Box3().setFromObject(group);
    const center = box.getCenter(new THREE.Vector3());
    group.position.sub(center);

    scene.add(group);
    meshRef.current = group;

    // Grid helper
    const gridHelper = new THREE.GridHelper(200, 20, 0x444444, 0x222222);
    gridHelper.position.y = -10;
    gridHelper.visible = showGrid;
    scene.add(gridHelper);

    // Mouse controls
    let isDragging = false;
    let prevMouse = { x: 0, y: 0 };
    let targetRotation = { x: 0.3, y: 0.4 };
    let currentRotation = { x: 0.3, y: 0.4 };

    const onMouseDown = (e) => {
      isDragging = true;
      setIsRotating(false);
      prevMouse = { x: e.clientX, y: e.clientY };
      renderer.domElement.style.cursor = 'grabbing';
    };

    const onMouseMove = (e) => {
      if (!isDragging) return;
      const dx = e.clientX - prevMouse.x;
      const dy = e.clientY - prevMouse.y;
      targetRotation.y += dx * 0.005;
      targetRotation.x += dy * 0.005;
      prevMouse = { x: e.clientX, y: e.clientY };
    };

    const onMouseUp = () => {
      isDragging = false;
      renderer.domElement.style.cursor = 'grab';
    };

    const onWheel = (e) => {
      e.preventDefault();
      camera.position.z += e.deltaY * 0.1;
      camera.position.z = Math.max(50, Math.min(300, camera.position.z));
      setZoomLevel(camera.position.z);
    };

    renderer.domElement.style.cursor = 'grab';
    renderer.domElement.addEventListener('mousedown', onMouseDown);
    renderer.domElement.addEventListener('mousemove', onMouseMove);
    renderer.domElement.addEventListener('mouseup', onMouseUp);
    renderer.domElement.addEventListener('wheel', onWheel);

    // Animation loop
    const animate = () => {
      frameRef.current = requestAnimationFrame(animate);

      if (isRotating && !isDragging) {
        targetRotation.y += 0.003;
      }

      currentRotation.x += (targetRotation.x - currentRotation.x) * 0.1;
      currentRotation.y += (targetRotation.y - currentRotation.y) * 0.1;

      if (meshRef.current) {
        meshRef.current.rotation.x = currentRotation.x;
        meshRef.current.rotation.y = currentRotation.y;
      }

      renderer.render(scene, camera);
    };
    animate();

    // Handle resize
    const handleResize = () => {
      if (!containerRef.current || !camera || !renderer) return;
      camera.aspect = containerRef.current.clientWidth / containerRef.current.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(containerRef.current.clientWidth, containerRef.current.clientHeight);
    };
    window.addEventListener('resize', handleResize);

    return () => {
      window.removeEventListener('resize', handleResize);
      if (renderer && renderer.domElement) {
        renderer.domElement.removeEventListener('mousedown', onMouseDown);
        renderer.domElement.removeEventListener('mousemove', onMouseMove);
        renderer.domElement.removeEventListener('mouseup', onMouseUp);
        renderer.domElement.removeEventListener('wheel', onWheel);
      }
      cancelAnimationFrame(frameRef.current);
      if (renderer) {
        renderer.dispose();
      }
      if (geometry) {
        geometry.dispose();
      }
      if (material) {
        material.dispose();
      }
      if (edgeMaterial) {
        edgeMaterial.dispose();
      }
      if (edges) {
        edges.dispose();
      }
      if (containerRef.current && renderer && renderer.domElement) {
        containerRef.current.removeChild(renderer.domElement);
      }
    };
  }, [isClient, isRotating, showEdges, showGrid, wireframe, viewMode, explodedView]);

  // Control functions
  const toggleRotation = () => setIsRotating(v => !v);
  
  const resetView = () => {
    if (!meshRef.current) return;
    meshRef.current.rotation.set(0.3, 0.4, 0);
    if (cameraRef.current) {
      cameraRef.current.position.set(150, 120, 150);
      setZoomLevel(150);
    }
  };

  const zoomIn = () => {
    if (!cameraRef.current) return;
    cameraRef.current.position.z = Math.max(50, cameraRef.current.position.z - 20);
    setZoomLevel(cameraRef.current.position.z);
  };

  const zoomOut = () => {
    if (!cameraRef.current) return;
    cameraRef.current.position.z = Math.min(300, cameraRef.current.position.z + 20);
    setZoomLevel(cameraRef.current.position.z);
  };

  const toggleGrid = () => setShowGrid(v => !v);
  
  const toggleWireframe = () => {
    setWireframe(v => !v);
    if (meshRef.current && meshRef.current.children[0]) {
      meshRef.current.children[0].material.wireframe = !wireframe;
    }
  };

  const toggleEdges = () => setShowEdges(v => !v);

  const toggleViewMode = () => {
    const modes = ['solid', 'wireframe', 'transparent'];
    const currentIndex = modes.indexOf(viewMode);
    const nextIndex = (currentIndex + 1) % modes.length;
    setViewMode(modes[nextIndex]);
    
    if (meshRef.current && meshRef.current.children[0]) {
      const material = meshRef.current.children[0].material;
      switch (modes[nextIndex]) {
        case 'solid':
          material.opacity = 0.95;
          material.transparent = false;
          material.wireframe = false;
          break;
        case 'wireframe':
          material.opacity = 1;
          material.transparent = false;
          material.wireframe = true;
          break;
        case 'transparent':
          material.opacity = 0.3;
          material.transparent = true;
          material.wireframe = false;
          break;
      }
    }
  };

  if (!isClient) {
    return (
      <div className="relative w-full h-full bg-gradient-to-br from-gray-900 to-black rounded-xl overflow-hidden flex items-center justify-center">
        <div className="text-white text-lg">Initializing 3D viewer...</div>
      </div>
    );
  }

  return (
    <div className="relative w-full h-full bg-gradient-to-br from-gray-900 to-black rounded-xl overflow-hidden">
      <div ref={containerRef} className="w-full h-full" />
      
      {/* Top controls */}
      <div className="absolute top-4 left-4 flex flex-col gap-2">
        <button 
          onClick={toggleRotation}
          className={`p-3 rounded-lg flex items-center justify-center transition-all ${isRotating ? 'bg-blue-600 text-white' : 'bg-gray-900/80 text-gray-300 hover:bg-gray-800'}`}
          title={isRotating ? 'Stop Rotation' : 'Start Rotation'}
        >
          <Camera size={20} />
        </button>

        <button 
          onClick={resetView}
          className="p-3 bg-gray-900/80 text-gray-300 rounded-lg hover:bg-gray-800 transition-all"
          title="Reset View"
        >
          <RotateCcw size={20} />
        </button>

        <button 
          onClick={toggleGrid}
          className={`p-3 rounded-lg flex items-center justify-center transition-all ${showGrid ? 'bg-green-600 text-white' : 'bg-gray-900/80 text-gray-300 hover:bg-gray-800'}`}
          title={showGrid ? 'Hide Grid' : 'Show Grid'}
        >
          <Grid3x3 size={20} />
        </button>

        <button 
          onClick={toggleViewMode}
          className="p-3 bg-gray-900/80 text-gray-300 rounded-lg hover:bg-gray-800 transition-all"
          title="Change View Mode"
        >
          <Eye size={20} />
        </button>
      </div>

      {/* Right controls */}
      <div className="absolute top-4 right-4 flex flex-col gap-2">
        <button 
          onClick={zoomIn}
          className="p-3 bg-gray-900/80 text-gray-300 rounded-lg hover:bg-gray-800 transition-all"
          title="Zoom In"
        >
          <ZoomIn size={20} />
        </button>

        <button 
          onClick={zoomOut}
          className="p-3 bg-gray-900/80 text-gray-300 rounded-lg hover:bg-gray-800 transition-all"
          title="Zoom Out"
        >
          <ZoomOut size={20} />
        </button>

        <button 
          onClick={toggleEdges}
          className={`p-3 rounded-lg flex items-center justify-center transition-all ${showEdges ? 'bg-cyan-600 text-white' : 'bg-gray-900/80 text-gray-300 hover:bg-gray-800'}`}
          title={showEdges ? 'Hide Edges' : 'Show Edges'}
        >
          <Box size={20} />
        </button>

        <button 
          onClick={toggleWireframe}
          className={`p-3 rounded-lg flex items-center justify-center transition-all ${wireframe ? 'bg-purple-600 text-white' : 'bg-gray-900/80 text-gray-300 hover:bg-gray-800'}`}
          title={wireframe ? 'Hide Wireframe' : 'Show Wireframe'}
        >
          <Maximize2 size={20} />
        </button>
      </div>

      {/* Bottom status bar */}
      <div className="absolute bottom-4 left-4 right-4 flex justify-between items-center">
        <div className="px-4 py-2 bg-gray-900/80 text-gray-300 rounded-lg backdrop-blur-sm">
          <span className="font-medium">Membrane Sensor</span>
          <span className="mx-2">•</span>
          <span className="text-sm">Zoom: {Math.round((300 - zoomLevel) / 250 * 100)}%</span>
        </div>
        
        <div className="flex gap-2">
          <div className={`px-3 py-1 rounded-full text-sm ${isRotating ? 'bg-blue-500/20 text-blue-300' : 'bg-gray-800/50 text-gray-400'}`}>
            {isRotating ? 'Rotating' : 'Static'}
          </div>
          <div className={`px-3 py-1 rounded-full text-sm ${showEdges ? 'bg-cyan-500/20 text-cyan-300' : 'bg-gray-800/50 text-gray-400'}`}>
            Edges {showEdges ? 'On' : 'Off'}
          </div>
          <div className={`px-3 py-1 rounded-full text-sm ${viewMode === 'solid' ? 'bg-green-500/20 text-green-300' : viewMode === 'wireframe' ? 'bg-purple-500/20 text-purple-300' : 'bg-blue-500/20 text-blue-300'}`}>
            {viewMode.charAt(0).toUpperCase() + viewMode.slice(1)}
          </div>
        </div>
      </div>

      {/* Instructions */}
      <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 bg-gray-900/60 text-gray-300 text-sm rounded-lg backdrop-blur-sm">
        Click and drag to rotate • Scroll to zoom
      </div>
    </div>
  );
};

export default MembraneSensorViewer;